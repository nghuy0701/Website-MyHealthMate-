name: CI/CD Pipeline

# Temporarily disabled - Enable when ready for production deployment
on:
  workflow_dispatch:
  # push:
  #   branches: [ main, develop ]
  # pull_request:
  #   branches: [ main, develop ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Lint and Test Backend
  backend-lint-test:
    name: Backend - Lint & Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'yarn'
          cache-dependency-path: Backend/yarn.lock

      - name: Install dependencies
        working-directory: ./Backend
        run: yarn install --frozen-lockfile

      - name: Run linter
        working-directory: ./Backend
        run: yarn lint

      - name: Build backend
        working-directory: ./Backend
        run: yarn build

  # Lint and Build Frontend
  frontend-lint-build:
    name: Frontend - Lint & Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: Frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./Frontend
        run: npm install --legacy-peer-deps

      - name: Build frontend
        working-directory: ./Frontend
        run: npm run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL || 'http://localhost:8017' }}

  # Test ML Service
  ml-service-test:
    name: ML Service - Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
          cache: 'pip'
          cache-dependency-path: ml-service/requirements.txt

      - name: Install dependencies
        working-directory: ./ml-service
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check Python syntax
        working-directory: ./ml-service
        run: python -m py_compile app.py

  # Build and Push Docker Images
  build-and-push:
    name: Build & Push Docker Images
    runs-on: ubuntu-latest
    needs: [backend-lint-test, frontend-lint-build, ml-service-test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        service: [backend, frontend, ml-service]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service == 'ml-service' && 'ml-service' || matrix.service == 'backend' && 'Backend' || 'Frontend' }}
          file: ./${{ matrix.service == 'ml-service' && 'ml-service' || matrix.service == 'backend' && 'Backend' || 'Frontend' }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Deploy to Production
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-and-push]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: ${{ secrets.PRODUCTION_URL || 'https://myhealthmate.yourdomain.com' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file on server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            cd /opt/myhealthmate
            
            # Backup existing .env if exists
            if [ -f .env ]; then
              cp .env .env.backup.$(date +%Y%m%d_%H%M%S)
            fi
            
            # Create new .env from secrets
            cat > .env << 'EOL'
            # =================================================================
            # MyHealthMate Environment Configuration
            # Generated by GitHub Actions CI/CD Pipeline
            # Date: $(date)
            # =================================================================

            # Environment
            NODE_ENV=production

            # Database (Critical Infrastructure)
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            DATABASE_NAME=${{ secrets.DATABASE_NAME || 'myhealthmate' }}

            # Cache & Session
            REDIS_URL=${{ secrets.REDIS_URL || 'redis://redis:6379' }}
            SESSION_SECRET=${{ secrets.SESSION_SECRET }}

            # Security & Authentication
            ADMIN_SECRET_KEY=${{ secrets.ADMIN_SECRET_KEY }}

            # Application Server
            APP_HOST=${{ secrets.APP_HOST || '0.0.0.0' }}
            APP_PORT=${{ secrets.APP_PORT || '8017' }}
            CLIENT_URL=${{ secrets.CLIENT_URL }}
            WEBSITE_DOMAIN_DEV=${{ secrets.WEBSITE_DOMAIN_DEV }}

            # Internal Services
            ML_SERVICE_URL=${{ secrets.ML_SERVICE_URL || 'http://ml-service:5001' }}

            # CORS Configuration
            ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}

            # External Services - Cloudinary (Image Storage)
            CLOUDINARY_URL=${{ secrets.CLOUDINARY_URL }}
            CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}
            CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}
            CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}

            # External Services - Brevo (Email)
            BREVO_API_KEY=${{ secrets.BREVO_API_KEY }}
            BREVO_SENDER_EMAIL=${{ secrets.BREVO_SENDER_EMAIL }}

            # Frontend Configuration
            VITE_API_URL=${{ secrets.VITE_API_URL }}

            # Docker MongoDB Configuration
            MONGO_INITDB_ROOT_USERNAME=${{ secrets.MONGO_ROOT_USER || 'admin' }}
            MONGO_INITDB_ROOT_PASSWORD=${{ secrets.MONGO_ROOT_PASSWORD }}
            MONGO_INITDB_DATABASE=${{ secrets.DATABASE_NAME || 'myhealthmate' }}

            # Metadata
            AUTHOR=${{ secrets.AUTHOR || 'MyHealthMate Team' }}
            EOL

      - name: Deploy with Docker Compose
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SERVER_PORT || 22 }}
          script: |
            cd /opt/myhealthmate
            
            # Pull latest code
            git pull origin main
            
            # Pull latest images
            docker-compose pull
            
            # Stop and remove old containers
            docker-compose down
            
            # Start new containers
            docker-compose up -d
            
            # Wait for services to be healthy
            echo "Waiting for services to start..."
            sleep 30
            
            # Check container status
            docker-compose ps
            
            # Clean up unused images
            docker system prune -f

      - name: Verify deployment
        run: |
          echo "Waiting for deployment to complete..."
          sleep 60
          
          # Check if production URL is accessible
          PROD_URL="${{ secrets.PRODUCTION_URL || 'https://myhealthmate.yourdomain.com' }}"
          echo "Checking $PROD_URL"
          
          if curl -f -s -o /dev/null -w "%{http_code}" "$PROD_URL" | grep -q "200\|301\|302"; then
            echo "✅ Deployment verified successfully!"
          else
            echo "❌ Deployment verification failed!"
            exit 1
          fi

  # Notify Deployment Status
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    
    steps:
      - name: Send Success Notification
        if: needs.deploy.result == 'success'
        run: |
          echo "✅ Deployment completed successfully!"
          echo "Service Status: All services are running"
          echo "Production URL: ${{ secrets.PRODUCTION_URL || 'https://myhealthmate.yourdomain.com' }}"
          echo "Deployed at: $(date)"

      - name: Send Failure Notification
        if: needs.deploy.result == 'failure'
        run: |
          echo "❌ Deployment failed!"
          echo "Please check the deployment logs and fix the issues."
          echo "You can rollback using: docker-compose down && docker-compose up -d"
          exit 1
