# ============================================================================
# MyHealthMate - Docker Compose Configuration
# ============================================================================
# Application: Diabetes Risk Prediction Platform
# Architecture: Microservices (Frontend, Backend, ML Service)
# Database: MongoDB Atlas (Cloud)
# Package Manager: npm (Node.js), pip (Python)
# ============================================================================

services:
  # ==========================================================================
  # ML SERVICE - Python Flask API
  # ==========================================================================
  # Purpose: Machine Learning predictions using 15+ trained models
  # Tech: Python 3.9, Flask, Scikit-learn, Pandas
  # Port: 5001
  # ==========================================================================
  ml-service:
    build:
      context: ./ml-service
      dockerfile: Dockerfile
      args:
        MODEL_VERSION: ${MODEL_VERSION:-20251023_210956}
    container_name: myhealthmate-ml-service
    restart: unless-stopped
    
    environment:
      FLASK_ENV: ${FLASK_ENV:-development}
      FLASK_DEBUG: "True"
      ML_HOST: 0.0.0.0
      ML_PORT: 5001
      LOG_LEVEL: ${LOG_LEVEL:-DEBUG}
      MODEL_VERSION: ${MODEL_VERSION:-20251023_210956}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:8017}
    
    ports:
      - "5001:5001"
    
    volumes:
      - ./ml-service/models:/app/models:ro
      - ./ml-service/data:/app/data:ro
    
    networks:
      - myhealthmate-network
    
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:5001/health')"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ==========================================================================
  # BACKEND SERVICE - Node.js Express API
  # ==========================================================================
  # Purpose: REST API, business logic, database operations
  # Tech: Node.js 18, Express, Babel, MongoDB Driver
  # Port: 8017
  # Dependencies: MongoDB Atlas (cloud), ML Service
  # ==========================================================================
  
  backend:
    build:
      context: ./Backend
      dockerfile: Dockerfile
    container_name: myhealthmate-backend
    restart: unless-stopped
    
    environment:
      # Application
      NODE_ENV: ${NODE_ENV:-development}
      APP_HOST: 0.0.0.0
      APP_PORT: 8017
      CLIENT_URL: ${CLIENT_URL:-http://localhost:3000}
      WEBSITE_DOMAIN_DEV: ${WEBSITE_DOMAIN_DEV:-http://localhost:3000}
      WEBSITE_DOMAIN_PROD: ${WEBSITE_DOMAIN_PROD:-}
      AUTHOR: ${AUTHOR:-MyHealthMate Team}
      
      # Database (MongoDB Atlas - Cloud)
      MONGODB_URI: ${MONGODB_URI}
      DATABASE_NAME: ${DATABASE_NAME:-MyhealthMate_db}
      
      # Security
      SESSION_SECRET: ${SESSION_SECRET}
      ADMIN_SECRET_KEY: ${ADMIN_SECRET_KEY}
      
      # Internal Services
      ML_SERVICE_URL: http://ml-service:5001
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:8017}
      
      # External Services - Cloudinary (Image Storage)
      CLOUDINARY_URL: ${CLOUDINARY_URL}
      CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
      CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
      CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}
      
      # External Services - Brevo (Email)
      BREVO_API_KEY: ${BREVO_API_KEY}
      BREVO_SENDER_EMAIL: ${BREVO_SENDER_EMAIL}
    
    ports:
      - "8017:8017"
    
    depends_on:
      ml-service:
        condition: service_healthy
    
    networks:
      - myhealthmate-network
    
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8017/api/v1/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 45s

  # ==========================================================================
  # FRONTEND SERVICE - React SPA + Nginx
  # ==========================================================================
  # Purpose: User interface, served as static files
  # Tech: React 18, Vite, TailwindCSS, Nginx
  # Port: 80
  # Dependencies: Backend API
  # ==========================================================================
  
  frontend:
    build:
      context: ./Frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:8017/api/v1}
    container_name: myhealthmate-frontend
    restart: unless-stopped
    
    environment:
      VITE_API_URL: ${VITE_API_URL:-http://localhost:8017/api/v1}
      VITE_APP_NAME: ${VITE_APP_NAME:-MyHealthMate}
      VITE_APP_VERSION: ${VITE_APP_VERSION:-1.0.0}
    
    ports:
      - "3000:80"
      - "443:443"
    
    depends_on:
      backend:
        condition: service_healthy
    
    networks:
      - myhealthmate-network
    
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ============================================================================
# NETWORK CONFIGURATION
# ============================================================================

networks:
  myhealthmate-network:
    driver: bridge
    name: myhealthmate-network

# ============================================================================
# USAGE COMMANDS
# ============================================================================
# Start all services:     docker-compose up -d --build
# View logs:              docker-compose logs -f
# Check status:           docker-compose ps
# Stop all:               docker-compose down
# Remove volumes:         docker-compose down -v
# Restart service:        docker-compose restart backend
# ============================================================================
